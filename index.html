<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskMaster Home Helper</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        .btn-primary {
            background-color: #4F46E5;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }
        .btn-primary:hover {
            background-color: #4338CA;
        }
        .btn-secondary {
            background-color: #6B7280;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }
        .btn-secondary:hover {
            background-color: #4B5563;
        }
        .btn-outline {
            border: 1px solid #D1D5DB;
            color: #4B5563;
            padding: 8px 16px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }
        .btn-outline:hover {
            background-color: #F3F4F6;
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 20px;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #4F46E5; /* Blue */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day {
            min-height: 80px;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            font-size: 0.875rem;
            position: relative;
            background-color: #F9FAFB;
        }
        .calendar-day.current-month {
            background-color: #ffffff;
        }
        .calendar-day-number {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .task-item {
            background-color: #DBEAFE; /* Light blue */
            color: #1E40AF; /* Dark blue */
            padding: 4px 8px;
            border-radius: 6px;
            margin-bottom: 4px;
            cursor: pointer;
            width: 100%;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 0.75rem;
        }
        .task-item.complete {
            background-color: #D1FAE5; /* Light green */
            color: #065F46; /* Dark green */
        }
        .task-item.in-progress {
            background-color: #FEF3C7; /* Light yellow */
            color: #92400E; /* Dark yellow */
        }
        .task-item.postponed {
            background-color: #FEE2E2; /* Light red */
            color: #991B1B; /* Dark red */
        }
        .task-item.manual {
            background-color: #E0E7FF; /* Lighter blue for manual */
            color: #3730A3; /* Indigo for manual */
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .flex-col-reverse-md {
                flex-direction: column-reverse;
            }
            .calendar-day {
                min-height: 60px;
                padding: 4px;
            }
            .calendar-day-number {
                font-size: 0.75rem;
            }
            .task-item {
                font-size: 0.65rem;
                padding: 2px 4px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center py-8">
    <div class="container mx-auto p-6 bg-white rounded-xl shadow-lg flex flex-col lg:flex-row gap-8">
        <!-- Left Panel: Project Input & AI Output -->
        <div class="lg:w-1/2 p-6 card">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Home Project Planner</h2>

            <!-- Project Input -->
            <div class="mb-6">
                <label for="projectDescription" class="block text-gray-700 text-sm font-medium mb-2">Describe your home improvement project or issue:</label>
                <textarea id="projectDescription" rows="6" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out" placeholder="e.g., Repair a drywall hole, fix a leaky faucet, paint a bedroom, install new shelves..."></textarea>
            </div>

            <button id="generatePlanBtn" class="btn-primary w-full flex items-center justify-center">
                <span id="generatePlanText">Generate Plan</span>
                <span id="loadingSpinner" class="loading-spinner hidden"></span>
            </button>

            <!-- AI Output -->
            <div id="aiOutput" class="mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200 hidden">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">AI-Generated Plan:</h3>
                <div class="mb-4">
                    <p class="text-gray-700 font-medium">Complexity/Severity: <span id="outputComplexity" class="font-normal text-indigo-600"></span></p>
                    <p class="text-gray-700 font-medium">Estimated Deadline: <span id="outputDeadline" class="font-normal text-indigo-600"></span></p>
                </div>
                <div class="mb-4">
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Materials & Tools Needed:</h4>
                    <ul id="outputMaterials" class="list-disc list-inside text-gray-600"></ul>
                </div>
                <div>
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Tutorials & Resources:</h4>
                    <ul id="outputTutorials" class="list-disc list-inside text-gray-600"></ul>
                </div>
                <button id="addAITaskToCalendarBtn" class="btn-primary mt-6 w-full">Add to Calendar</button>
            </div>

            <!-- Message Box for Alerts -->
            <div id="messageBox" class="modal">
                <div class="modal-content">
                    <span class="close-button" id="closeMessageBox">&times;</span>
                    <p id="messageText" class="text-gray-800 text-lg"></p>
                    <button id="messageBoxOkBtn" class="btn-primary mt-4 float-right">OK</button>
                </div>
            </div>

        </div>

        <!-- Right Panel: Calendar & Task Management -->
        <div class="lg:w-1/2 p-6 card flex flex-col">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Your Project Calendar</h2>

            <!-- Calendar Navigation -->
            <div class="flex justify-between items-center mb-4">
                <button id="prevMonthBtn" class="btn-outline px-4 py-2 rounded-lg"><i class="fas fa-chevron-left"></i></button>
                <h3 id="currentMonthYear" class="text-xl font-semibold text-gray-800"></h3>
                <button id="nextMonthBtn" class="btn-outline px-4 py-2 rounded-lg"><i class="fas fa-chevron-right"></i></button>
            </div>

            <!-- Days of the week header -->
            <div class="grid grid-cols-7 gap-4 text-center font-medium text-gray-600 mb-2">
                <div>Sun</div>
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
            </div>

            <!-- Calendar Grid -->
            <div id="calendarGrid" class="calendar-grid flex-grow">
                <!-- Calendar days will be generated here by JavaScript -->
            </div>

            <button id="addTaskManuallyBtn" class="btn-secondary mt-6 w-full">Manually Add Task</button>

            <!-- Modal for Adding/Editing/Viewing Task -->
            <div id="taskModal" class="modal">
                <div class="modal-content">
                    <span class="close-button" id="closeTaskModal">&times;</span>
                    <h3 id="taskModalTitle" class="text-2xl font-bold text-gray-800 mb-4">Add New Task</h3>

                    <div id="taskView" class="hidden">
                        <p class="mb-2"><span class="font-semibold">Description:</span> <span id="viewDescription"></span></p>
                        <p class="mb-2"><span class="font-semibold">Type:</span> <span id="viewType"></span></p>
                        <p class="mb-2"><span class="font-semibold">Status:</span> <span id="viewStatus"></span></p>
                        <p class="mb-2"><span class="font-semibold">Date:</span> <span id="viewDate"></span></p>
                        <p class="mb-2"><span class="font-semibold">Complexity:</span> <span id="viewComplexity"></span></p>
                        <p class="mb-2"><span class="font-semibold">Severity:</span> <span id="viewSeverity"></span></p>
                        <p class="mb-2"><span class="font-semibold">Materials:</span> <ul id="viewMaterials" class="list-disc list-inside ml-4"></ul></p>
                        <p class="mb-2"><span class="font-semibold">Tutorials:</span> <ul id="viewTutorials" class="list-disc list-inside ml-4"></ul></p>

                        <div class="flex justify-end gap-2 mt-4">
                            <button id="markCompleteBtn" class="btn-primary">Mark Complete</button>
                            <button id="markInProgressBtn" class="btn-secondary">Mark In Progress</button>
                            <button id="markPostponedBtn" class="btn-outline">Mark Postponed</button>
                            <button id="deleteTaskBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-150 ease-in-out">Delete</button>
                        </div>
                    </div>

                    <div id="taskEdit" class="">
                        <div class="mb-4">
                            <label for="taskDescriptionInput" class="block text-gray-700 text-sm font-medium mb-2">Task Description:</label>
                            <input type="text" id="taskDescriptionInput" class="w-full p-2 border border-gray-300 rounded-lg" required>
                        </div>
                        <div class="mb-4">
                            <label for="taskDateInput" class="block text-gray-700 text-sm font-medium mb-2">Date:</label>
                            <input type="date" id="taskDateInput" class="w-full p-2 border border-gray-300 rounded-lg" required>
                        </div>
                        <div class="mb-4">
                            <label for="taskStatusInput" class="block text-gray-700 text-sm font-medium mb-2">Status:</label>
                            <select id="taskStatusInput" class="w-full p-2 border border-gray-300 rounded-lg">
                                <option value="pending">Pending</option>
                                <option value="in-progress">In Progress</option>
                                <option value="complete">Complete</option>
                                <option value="postponed">Postponed</option>
                            </select>
                        </div>
                        <div class="flex justify-end gap-2 mt-4">
                            <button id="saveTaskBtn" class="btn-primary">Save Task</button>
                            <button id="cancelTaskBtn" class="btn-outline">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, query, where, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBmtejvlfgak7_Ri_3Pl4VJmh-psAElae0",
        authDomain: "home-improvement-77903.firebaseapp.com",
        projectId: "home-improvement-77903",
        storageBucket: "home-improvement-77903.firebasestorage.app",
        messagingSenderId: "1002228751462",
        appId: "1:1002228751462:web:88aefba46cbb28c503e1a7",
    };

    // Global variables provided by the Canvas environment (prefer this if deployed in Canvas)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    // const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Initialize Firebase
    let app;
    let db;
    let auth;
    let userId = null;
    let isAuthReady = false;

    // Message Box Elements
    const messageBox = document.getElementById('messageBox');
    const messageText = document.getElementById('messageText');
    const closeMessageBox = document.getElementById('closeMessageBox');
    const messageBoxOkBtn = document.getElementById('messageBoxOkBtn');

    function showMessage(message) {
        messageText.textContent = message;
        messageBox.style.display = 'flex';
    }

    closeMessageBox.onclick = () => messageBox.style.display = 'none';
    messageBoxOkBtn.onclick = () => messageBox.style.display = 'none';
    window.onclick = (event) => {
        if (event.target == messageBox) {
            messageBox.style.display = 'none';
        }
        if (event.target == taskModal) {
            taskModal.style.display = 'none';
        }
    };

    // Task Modal Elements
    const taskModal = document.getElementById('taskModal');
    const closeTaskModal = document.getElementById('closeTaskModal');
    const taskModalTitle = document.getElementById('taskModalTitle');
    const taskView = document.getElementById('taskView');
    const taskEdit = document.getElementById('taskEdit');

    const viewDescription = document.getElementById('viewDescription');
    const viewType = document.getElementById('viewType');
    const viewStatus = document.getElementById('viewStatus');
    const viewDate = document.getElementById('viewDate');
    const viewComplexity = document.getElementById('viewComplexity');
    const viewSeverity = document.getElementById('viewSeverity');
    const viewMaterials = document.getElementById('viewMaterials');
    const viewTutorials = document.getElementById('viewTutorials');

    const taskDescriptionInput = document.getElementById('taskDescriptionInput');
    const taskDateInput = document.getElementById('taskDateInput');
    const taskStatusInput = document.getElementById('taskStatusInput');
    const saveTaskBtn = document.getElementById('saveTaskBtn');
    const cancelTaskBtn = document.getElementById('cancelTaskBtn');
    const markCompleteBtn = document.getElementById('markCompleteBtn');
    const markInProgressBtn = document.getElementById('markInProgressBtn');
    const markPostponedBtn = document.getElementById('markPostponedBtn');
    const deleteTaskBtn = document.getElementById('deleteTaskBtn');

    let currentEditingTask = null; // Stores the task object being viewed/edited

    closeTaskModal.onclick = () => taskModal.style.display = 'none';
    cancelTaskBtn.onclick = () => taskModal.style.display = 'none';

    // App State
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let tasks = []; // Array to store all tasks fetched from Firestore

    // DOM Elements
    const projectDescriptionInput = document.getElementById('projectDescription');
    const generatePlanBtn = document.getElementById('generatePlanBtn');
    const generatePlanText = document.getElementById('generatePlanText');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const aiOutputDiv = document.getElementById('aiOutput');
    const outputComplexity = document.getElementById('outputComplexity');
    const outputDeadline = document.getElementById('outputDeadline');
    const outputSeverity = document.getElementById('outputSeverity'); // ADDED THIS LINE
    const outputMaterials = document.getElementById('outputMaterials');
    const outputTutorials = document.getElementById('outputTutorials');
    const addAITaskToCalendarBtn = document.getElementById('addAITaskToCalendarBtn');

    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    const currentMonthYearHeader = document.getElementById('currentMonthYear');
    const calendarGrid = document.getElementById('calendarGrid');
    const addTaskManuallyBtn = document.getElementById('addTaskManuallyBtn');

    // Initialize Firebase and Auth
    if (Object.keys(firebaseConfig).length > 0) {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("Authenticated with Firebase UID:", userId);
                isAuthReady = true;
                // Fetch tasks after auth is ready
                setupTaskListener();
            } else {
                // Sign in anonymously if no user is logged in and no custom token is provided
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase authentication error:", error);
                    showMessage("Failed to authenticate with Firebase. Please try again later.");
                    // Fallback to a local UUID if Firebase auth fails completely
                    userId = localStorage.getItem('localUserId');
                    if (!userId) {
                        userId = crypto.randomUUID();
                        localStorage.setItem('localUserId', userId);
                    }
                    isAuthReady = true;
                    setupTaskListener(); // Still try to fetch tasks with local ID if possible
                }
            }
        });
    } else {
        console.warn("Firebase config not provided. Tasks will not be persistent.");
        // Fallback to a local UUID if Firebase config is missing
        userId = localStorage.getItem('localUserId');
        if (!userId) {
            userId = crypto.randomUUID();
            localStorage.setItem('localUserId', userId);
        }
        isAuthReady = true;
        // Proceed without Firestore if not configured
        renderCalendar();
    }

    // Function to set up real-time listener for tasks
    function setupTaskListener() {
        if (db && userId) {
            const tasksColRef = collection(db, `artifacts/${appId}/users/${userId}/tasks`);
            onSnapshot(tasksColRef, (snapshot) => {
                tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Tasks fetched:", tasks);
                renderCalendar();
            }, (error) => {
                console.error("Error fetching tasks:", error);
                showMessage("Failed to load tasks. Please check your internet connection.");
            });
        } else {
            renderCalendar(); // Render calendar even if no DB connection
        }
    }

    // Function to add/update a task in Firestore
    async function saveTask(taskData) {
        if (!isAuthReady) {
            showMessage("App is not ready. Please wait for authentication.");
            return;
        }
        if (!db || !userId) {
            showMessage("Firestore is not configured. Task cannot be saved.");
            return;
        }

        try {
            if (taskData.id) {
                // Update existing task
                const taskRef = doc(db, `artifacts/${appId}/users/${userId}/tasks`, taskData.id);
                await updateDoc(taskRef, taskData);
                showMessage("Task updated successfully!");
            } else {
                // Add new task
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/tasks`), taskData);
                showMessage("Task added successfully!");
            }
            taskModal.style.display = 'none';
        } catch (e) {
            console.error("Error saving task: ", e);
            showMessage("Failed to save task. Please try again.");
        }
    }

    // Function to delete a task from Firestore
    async function deleteTask(taskId) {
        if (!isAuthReady) {
            showMessage("App is not ready. Please wait for authentication.");
            return;
        }
        if (!db || !userId) {
            showMessage("Firestore is not configured. Task cannot be deleted.");
            return;
        }

        try {
            await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/tasks`, taskId));
            showMessage("Task deleted successfully!");
            taskModal.style.display = 'none';
        } catch (e) {
            console.error("Error deleting task: ", e);
            showMessage("Failed to delete task. Please try again.");
        }
    }

    // AI Integration
    generatePlanBtn.addEventListener('click', async () => {
        const description = projectDescriptionInput.value.trim();
        if (!description) {
            showMessage("Please enter a description for your project.");
            return;
        }

        generatePlanText.textContent = 'Generating...';
        loadingSpinner.classList.remove('hidden');
        generatePlanBtn.disabled = true;
        aiOutputDiv.classList.add('hidden'); // Hide previous output

        try {
            const prompt = `Analyze the following home improvement or repair project: "${description}".
            Based on this, provide:
            1. A classification of its complexity (Simple, Moderate, Advanced).
            2. A classification of its severity (Minor, Urgent, Cosmetic, Structural).
            3. An estimated deadline in days.
            4. A list of materials and tools required.
            5. A list of generic tutorial search terms or placeholder URLs for tutorials.

            Respond only with a JSON object adhering to this schema:
            ${JSON.stringify({
                type: "OBJECT",
                properties: {
                    complexity: { "type": "STRING", "description": "e.g., Simple, Moderate, Advanced" },
                    severity: { "type": "STRING", "description": "e.g., Minor, Urgent, Cosmetic, Structural" },
                    estimatedDeadlineDays: { "type": "NUMBER", "description": "Estimated days to complete the task" },
                    materials: {
                        "type": "ARRAY",
                        "items": { "type": "STRING" },
                        "description": "List of materials and tools required"
                    },
                    tutorials: {
                        "type": "ARRAY",
                        "items": {
                            "type": "OBJECT",
                            "properties": {
                                "title": { "type": "STRING" },
                                "url": { "type": "STRING" }
                            }
                        },
                        "description": "List of tutorial links"
                    }
                },
                required: ["complexity", "severity", "estimatedDeadlineDays", "materials", "tutorials"]
            })}
            `;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "complexity": { "type": "STRING" },
                            "severity": { "type": "STRING" },
                            "estimatedDeadlineDays": { "type": "NUMBER" },
                            "materials": { "type": "ARRAY", "items": { "type": "STRING" } },
                            "tutorials": {
                                "type": "ARRAY",
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "title": { "type": "STRING" },
                                        "url": { "type": "STRING" }
                                    }
                                }
                            }
                        }
                    }
                }
            };

            const geminiApiKey = "AIzaSyDSMjcogi1lKfcz3xdYTqWVBWixBwpPoSs"
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`; // CORRECTED API KEY USAGE

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {

                const jsonString = result.candidates[0].content.parts[0].text;
                const aiData = JSON.parse(jsonString);

                // Display AI Output
                outputComplexity.textContent = aiData.complexity;
                outputSeverity.textContent = aiData.severity;
                outputDeadline.textContent = `${aiData.estimatedDeadlineDays} days`;

                outputMaterials.innerHTML = '';
                aiData.materials.forEach(material => {
                    const li = document.createElement('li');
                    li.textContent = material;
                    outputMaterials.appendChild(li);
                });

                outputTutorials.innerHTML = '';
                aiData.tutorials.forEach(tutorial => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = tutorial.url || `https://www.google.com/search?q=${encodeURIComponent(tutorial.title + " tutorial")}`; // Fallback to Google search
                    a.textContent = tutorial.title;
                    a.target = "_blank";
                    a.className = "text-blue-600 hover:underline";
                    li.appendChild(a);
                    outputTutorials.appendChild(li);
                });

                aiOutputDiv.classList.remove('hidden');

                // Store AI data temporarily for adding to calendar
                addAITaskToCalendarBtn.aiData = {
                    description: description,
                    type: 'AI-Generated',
                    complexity: aiData.complexity,
                    severity: aiData.severity,
                    estimatedDeadlineDays: aiData.estimatedDeadlineDays,
                    materials: aiData.materials,
                    tutorials: aiData.tutorials
                };

            } else {
                showMessage("AI could not generate a plan. Please try rephrasing your request.");
                console.error("AI response structure unexpected:", result);
            }

        } catch (error) {
            console.error("Error calling Gemini API:", error);
            showMessage("Failed to generate plan. Please check your internet connection or try again later.");
        } finally {
            generatePlanText.textContent = 'Generate Plan';
            loadingSpinner.classList.add('hidden');
            generatePlanBtn.disabled = false;
        }
    });

    // Add AI Task to Calendar
    addAITaskToCalendarBtn.addEventListener('click', () => {
        const aiData = addAITaskToCalendarBtn.aiData;
        if (!aiData) {
            showMessage("No AI plan generated yet to add.");
            return;
        }

        const today = new Date();
        const deadlineDate = new Date(today);
        deadlineDate.setDate(today.getDate() + aiData.estimatedDeadlineDays);

        const newTask = {
            description: aiData.description,
            type: aiData.type,
            status: 'pending',
            date: deadlineDate.toISOString().split('T')[0], //YYYY-MM-DD format
            complexity: aiData.complexity,
            severity: aiData.severity,
            materials: aiData.materials,
            tutorials: aiData.tutorials,
            createdAt: new Date().toISOString()
        };
        saveTask(newTask);
        aiOutputDiv.classList.add('hidden'); // Hide AI output after adding
        projectDescriptionInput.value = ''; // Clear input
    });

    // Calendar Rendering Logic
    function renderCalendar() {
        calendarGrid.innerHTML = '';
        const today = new Date();
        const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const firstDayOfWeek = firstDayOfMonth.getDay(); // 0 for Sunday, 1 for Monday, etc.

        currentMonthYearHeader.textContent = new Date(currentYear, currentMonth).toLocaleString('default', { month: 'long', year: 'numeric' });

        // Fill leading empty days
        for (let i = 0; i < firstDayOfWeek; i++) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day bg-gray-50';
            calendarGrid.appendChild(dayDiv);
        }

        // Fill days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(currentYear, currentMonth, day);
            const dayDiv = document.createElement('div');
            dayDiv.className = `calendar-day ${date.getMonth() === currentMonth ? 'current-month' : ''}`;

            const dayNumberSpan = document.createElement('span');
            dayNumberSpan.className = 'calendar-day-number';
            dayNumberSpan.textContent = day;
            dayDiv.appendChild(dayNumberSpan);

            // Add tasks for this day
            const tasksForDay = tasks.filter(task => {
                const taskDate = new Date(task.date + 'T00:00:00'); // Ensure UTC for consistent comparison
                return taskDate.getFullYear() === currentYear &&
                            taskDate.getMonth() === currentMonth &&
                            taskDate.getDate() === day;
            });

            tasksForDay.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = `task-item ${task.status} ${task.type === 'Manual' ? 'manual' : ''}`;
                taskItem.textContent = task.description;
                taskItem.dataset.taskId = task.id; // Store task ID
                taskItem.addEventListener('click', () => openTaskModal(task));
                dayDiv.appendChild(taskItem);
            });

            calendarGrid.appendChild(dayDiv);
        }
    }

    // Calendar Navigation
    prevMonthBtn.addEventListener('click', () => {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        renderCalendar();
    });

    nextMonthBtn.addEventListener('click', () => {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        renderCalendar();
    });

    // Manually Add Task Button
    addTaskManuallyBtn.addEventListener('click', () => {
        taskModalTitle.textContent = 'Add New Task';
        taskView.classList.add('hidden');
        taskEdit.classList.remove('hidden');
        taskDescriptionInput.value = '';
        taskDateInput.value = new Date().toISOString().split('T')[0]; // Default to today
        taskStatusInput.value = 'pending';
        currentEditingTask = null; // Clear any previously selected task
        taskModal.style.display = 'flex';
    });

    // Open Task Modal (for viewing/editing)
    function openTaskModal(task) {
        currentEditingTask = task;
        taskModalTitle.textContent = task.description;
        taskView.classList.remove('hidden');
        taskEdit.classList.add('hidden');

        viewDescription.textContent = task.description;
        viewType.textContent = task.type || 'Manual';
        viewStatus.textContent = task.status;
        viewDate.textContent = new Date(task.date + 'T00:00:00').toLocaleDateString();
        viewComplexity.textContent = task.complexity || 'N/A';
        viewSeverity.textContent = task.severity || 'N/A';

        viewMaterials.innerHTML = '';
        if (task.materials && task.materials.length > 0) {
            task.materials.forEach(material => {
                const li = document.createElement('li');
                li.textContent = material;
                viewMaterials.appendChild(li);
            });
        } else {
            const li = document.createElement('li');
            li.textContent = 'No materials listed.';
            viewMaterials.appendChild(li);
        }


        viewTutorials.innerHTML = '';
        if (task.tutorials && task.tutorials.length > 0) {
            task.tutorials.forEach(tutorial => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = tutorial.url || `https://www.google.com/search?q=${encodeURIComponent(tutorial.title + " tutorial")}`;
                a.textContent = tutorial.title;
                a.target = "_blank";
                a.className = "text-blue-600 hover:underline";
                li.appendChild(a);
                viewTutorials.appendChild(li);
            });
        } else {
            const li = document.createElement('li');
            li.textContent = 'No tutorials listed.';
            viewTutorials.appendChild(li);
        }

        // Update status buttons based on current task status
        markCompleteBtn.style.display = task.status === 'complete' ? 'none' : 'inline-block';
        markInProgressBtn.style.display = task.status === 'in-progress' ? 'none' : 'inline-block';
        markPostponedBtn.style.display = task.status === 'postponed' ? 'none' : 'inline-block';

        taskModal.style.display = 'flex';
    }

    // Save Task (Manual or AI-generated)
    saveTaskBtn.addEventListener('click', () => {
        const description = taskDescriptionInput.value.trim();
        const date = taskDateInput.value;
        const status = taskStatusInput.value;

        if (!description || !date) {
            showMessage("Please fill in all required fields.");
            return;
        }

        let taskData = { // Use 'let' for taskData as it might be modified
            description: description,
            date: date,
            status: status,
            type: 'Manual', // Default to 'Manual' for new manual tasks
            complexity: 'N/A',
            severity: 'N/A',
            materials: [],
            tutorials: [],
            createdAt: new Date().toISOString()
        };

        if (currentEditingTask) {
            // If editing an existing task, merge properties, but prioritize input fields for manual edits
            taskData = {
                ...currentEditingTask, // Start with existing task data
                description: description, // Override with current input
                date: date,             // Override with current input
                status: status,         // Override with current input
                // For AI-generated tasks, materials, tutorials, complexity, severity will be preserved from currentEditingTask
                // For manual tasks, they remain N/A or empty arrays as set initially
            };
            // Ensure type remains 'Manual' if it was a manual task, or 'AI-Generated' if it was AI
            if (currentEditingTask.type === 'AI-Generated') {
                taskData.type = 'AI-Generated';
            } else {
                taskData.type = 'Manual';
            }
        }
        saveTask(taskData);
    });

    // Task Status Update Buttons
    markCompleteBtn.addEventListener('click', () => {
        if (currentEditingTask) {
            saveTask({ ...currentEditingTask, status: 'complete' });
        }
    });

    markInProgressBtn.addEventListener('click', () => {
        if (currentEditingTask) {
            saveTask({ ...currentEditingTask, status: 'in-progress' });
        }
    });

    markPostponedBtn.addEventListener('click', () => {
        if (currentEditingTask) {
            saveTask({ ...currentEditingTask, status: 'postponed' });
        }
    });

    deleteTaskBtn.addEventListener('click', () => {
        if (currentEditingTask && confirm("Are you sure you want to delete this task?")) {
            deleteTask(currentEditingTask.id);
        }
    });

    // Initial calendar render on window load
    window.onload = () => {
        // Calendar will be rendered by setupTaskListener after auth is ready
        // If Firebase is not configured, it will render immediately.
    };
    </script>
</body>
</html>